## 概要

求めた直線、または曲線の図を取得する方法を学びましょう。また、モデルの正確性について詳しく検討していこう

# この章の目標

**推定完了時間: 1時間30分**

　単回帰分析、重回帰分析、多項式分析の手法の性能を比較してみましょう。また、求めた直線、または曲線をグラフにしてみましょう。

**1. 精度を比較して、図を求めてみんなに納得してもらおう**

# 精度の正確性をみていこう
　精度の正確性は今までは、決定係数、二乗誤差、平均二乗誤差でみてきました。
　ですが、例えば平均どれくらいの価格のズレがあるのか？や実際に比べて何パーセントくらいズレているのかといったほうがパッとみてわかりやすいと思いませんか？
　ですので、それらの指標をここでは加えて紹介します。

## 新しい精度の指標を学ぼう

　「実際に比べて何パーセントくらいズレているのか」は、平均絶対誤差率(MAPE)というのを用います。
　「平均どれくらいの価格のズレがあるのか？」は、平均絶対誤差(MAE)というものを使います。

### 平均絶対誤差率(MAPE)

　平均絶対誤差率というものは、

$$MAPE = \frac{100}{N} \sum_{i=1}^{N} \left|\frac{\hat y}{y_i} - 1\right|$$
$$N=データ数、 \hat{y}=実際のyの値、 y_i=測定されたyの値$$

で示される量のことです。すべての予測した点について絶対値を求めていきます。そしてそれらを合計し、予測した地点の総数nで割ります。最後に100をかけることでパーセントにしています。非常にわかりやすい指標ですね。ですが、この指標には多くの問題点があり、全てに用いれるわけではないです。

　区分と比率が意味のある値に対してのみMAPEは意味を持ちます。たとえば、温度ような割合を計算することができないものには用いることができません。
　また、0がデータに存在する場合にもゼロで割ることになってしまうため、使えません。
　また誤差が小さすぎる場合に、MAPEがとても大きくなるという問題もあります。100を超えてしまうことも考えられます。
　ですので用いる時は注意が必要です。

　平均誤差率は、pythonでは以下のようにかけます。ここでは、Numpyというモジュールの平均値を求めるmeanというメソッドを使っています。
　（）内は、多項式回帰の場合を示しています。

```python
print("平均誤差率(test):", np.mean(abs(実際の値(Y_test) / モデルの予測値(Y_pred) - 1)))
```

### 平均絶対誤差(MAE)

　平均絶対誤差というものは、

$$MAE = \frac{1}{N} \sum_{i=1}^{N} \left| \hat{y} - y_i \right|$$
$$N=データ数、 \hat{y}=実際のyの値、 y_i=測定されたyの値$$

で示されます。すべての予測した点について絶対値を求めていきます。そしてそれらを合計し、予測そた地点の総数nで割ります。これが何に役立つのでしょうか？
　これは、そのモデルがどれだけズレているか目的変数の単位で表示させるようにすることができます。例えば、今回の例で言えば、いくら住宅価格が平均してズレているかということを示すことができます。

　平均絶対誤差は、pythonでは以下のようにかけます。ここでは、scikit-learnの平均絶対誤差を求めるmean_absolute_errorを使っています。
　（）内は、多項式回帰の場合を示しています。

```python
from sklearn.metrics import mean_absolute_error
print("MAE(test):", mean_absolute_error(Y_test, Y_pred))
```

### 各略語について

　MAEにR2にと略語が多く出てきて何が何だかわからないかと思うのでここで以下の表で整理します。わからなくなったらここに戻ってきましょう。

|略語|意味|日本語|
|:--:|:--:|:--:|
|RMSE|Root Mean Squared Error|二乗平均平方根誤差|
|MSE|Mean Squared Error|平均二乗誤差|
|$R^2$|決定係数|決定係数|
|MAE|Mean Absolute Error|平均絶対誤差|
|MAPE|Mean Absolute Percentage Error|平均絶対誤差率|

## 新しい指標を使って誤差を比較してみよう
　それでは、新しい2つの新しい指標を使って比較してみましょう。
　ここでは、コードを書くよりも、分析するのがメインですので、すでに完成しているコードを下記に用意しましたので、リンク先で実行してみてみましょう。

[Google Colabの誤差比較完成コード](https://colab.research.google.com/drive/1mCmAymmQmEB2cZ8L_JvTFkm5BfBO6-gi?usp=sharing)

|指標|単回帰分析|重回帰分析|多項式回帰分析|
|:--:|:--:|:--:|:--:|
|RMSE(train)|6.04|5.37|4.32|
|RMSE(test)|6.81|6.11|5.31|
|MSE(train)|36.52|28.79|18.66|
|MSE(test)|46.34|37.38|28.14|
|R2(train)|0.57|0.66|0.78|
|R2(test)|0.43|0.54|0.65|
|MAE(test)|4.86|4.14|3.34|
|MAPE(test)|0.31|0.25|0.16|

　以上のような表が見れたと思います。これから見ると、
　RMSEは多項式回帰分析が最も学習と検証の乖離が大きく、これは外れ値をうまく学習しきれていないことを表しています。だから決して使えないというわけではなく、そのデータを利用する場合にこれはよります。例えば外れ値に注目したい場合に、これは活用することはできませんが、中央値のような値に注目したい場合には有用であると言えます。
　R2からは、1に近ずいておりより当てはまりが良くなっています。しかし、モデルの当てはまりすぎ「too good to be true」すなわち、「そのモデルの精度が高過ぎるんじゃないか」という原因は「実は汎化性能を見てませんでした」といことを示していることもありますので汎用性に注意しましょう。汎用性の指標には、時と場合によりますので、場合によってはこれらの指標以外のものを使わなければならない可能性もあります。
　MAEからは多項式回帰分析は$3340のズレと単回帰分析に比べ約40%、重回帰分析に比べ約20%よく住宅価格を予測できており、精度向上がみられます。
　MAPEからは多項式回帰分析は標準から16%のズレと単回帰分析に比べるとよく近似できていることがわかります。

# それぞれのグラフを書こう
　それでは、残差プロットを並べてみてみましょう。
　再びここでは、コードを書くよりも、分析するのがメインですので、すでに完成しているコードを下記に用意しましたので、リンク先で実行してみてみましょう。

[Google Colabの残差プロット完成コード](https://colab.research.google.com/drive/1jkTnNeNGKxFu8DWX-kCYUifC-kwIMSEm?usp=sharing)

![](/media/editor/D-9残差３つの比較_20201130143409408008.png)

　残差プロットは、目的変数の真値と予測値の差分(残差)の分布をグラフ化したものです。モデルが目的変数を完璧に予測できる場合は残差は0となる性質を持っています。また、予測精度の良いモデルの残差プロットは、0を中心にランダムにばらついたものになります。残差プロットに何かパターンが見られる場合は、そのモデルで説明しきれない情報があるということでしたね。
　以上の3つのグラフはどうでしょうか？単回帰分析、重回帰分析、多項式回帰分析の順で0を中心にランダムにばらついたものになっていないでしょうか？
　しかしながら、多項式回帰分析になるにつれて、直線的な傾向強くなり、モデルに取り切れていない情報の影響が大きくなっているといことがわかります。
　これは、先ほど見たRMSEの結果と一致していますね。