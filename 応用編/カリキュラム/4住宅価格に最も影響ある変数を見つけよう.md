## 概要

pandasを使ってデータ間の相関係数を求めましょう。相関係数がどのような場合に目的の変数を多く動かすような要因になっているのでしょうか？学習してみましょう。

# この章の目標

**推定完了時間:1時間**

　今は、ボストンの住宅価格のデータセットの住宅価格を求めるモデルを作りたいのですね。その住宅価格を一番左右する変数はなんなのかデータ間の関係を求めて考える方法を学習しましょう。

**1. データ間の相関に関して考えられるようになる**

# 目的変数と説明変数
　今回行うことを再確認しましょう。ボストンの住宅価格のデータセットを分析して、目的変数である住宅価格を求めるための直線を引くことが目的でしたね。ですのでそこで改めて目的変数と説明変数を少し掘り下げて解説したいと思います。
### 目的変数
　目的変数は、住宅価格のデータです。
　おもに目的変数とは、「結果となっている変数」のことを言います。住宅価格というのは場所の特性やその人の年収などによって変動することが考えられますよね？ですので、そのような場所やその人の年収の結果が目的変数「住宅価格」として今求めるものになっているのです。
　ちなみに、ボストンの住宅価格のデータセットでは以下のようにして目的変数を取り出せます。

```python
from sklearn.datasets import load_boston

dataset = load_boston()
y = dataset.target

print(y)
```

### 説明変数
　説明変数は、住宅価格を左右する変数のことです。
　住宅価格は先ほどの例を使うと場所の特性やその人の年収などによって変動することが考えられます。その考えらえれる要素、すなわち目的変数を生む原因を説明変数というのです。
　ですので、目的変数と説明変数は「説明変数を受けて発生した結果となっている目的変数という関係である」ということができます。
　ちなみに、ボストンの住宅価格のデータセットでは以下のようにして説明変数を取り出せます。

```python
from sklearn.datasets import load_boston

dataset = load_boston()
x = dataset.data

print(x)
```

以下は、一次変数における目的変数と説明変数の例です。

![](/media/editor/D-3説明変数と目的変数_20201130142124162996.png)

# データ間の関係を見るにはどうしたらいいのか？
　それでは、目的変数と説明変数は理解しましたね。住宅価格は先ほどの例を使うと場所の特性やその人の年収などによって変動することが考えられますが、どの説明変数がどの程度目的変数に影響しているのでしょうか？例えば一番年収が住宅価格に影響していると考えます。ですが、あるひとは場所だろうと考えることもあるでしょう。人間がこう思うということで議論していてはキリがありません。ですので、<font color='red'>**相関係数**</font>というデータ間の関係を示す数学の知識を用いてどの説明変数がどの程度目的変数に影響しているのかみてみましょう。

## 相関係数とは
　数学で、相関があることを

- **一般に片方が増えると他方も増えるような関係を正の相関がある**
- **一般に片方が増えると他方も減るような関係を負の相関がある**

というよう言うのは習ったかと思います。相関係数がどのように計算されるかという具体的なものは高校数学の先生にお任せするとして、ここでは、相関係数の概念とプログラムで計算する方法を学びます。
　相関係数で何が判断できると思いますか？相関係数ではデータの単位や種類に寄らず正負の相関関係や相関の強さ（その程度データ間強い関係を持っているか）を持っているかを判断できるようになります。すなわち、どの説明がもっとも目的変数を変化させるものなのかということを判断出来る様になります。
　ですので、まず、相関係数を求めてみましょう。

$$相関係数 = \frac{\frac{1}{n} \sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\frac{1}{n} \sum_{i=1}^{n}(x_i - \bar{x})^2}\sqrt{\frac{1}{n} \sum_{i=1}^{n}(y_i - \bar{y})^2}}$$

|変数|意味|
|:--:|:--:|
|$n$|データ総数|
|$x_i$|i番目xのデータの値|
|$y_i$|i番目yのデータの値|
|$\bar{x}$|xの平均点|
|$\bar{y}$|yの平均点|

### 相関係数の求め方を知ろう

　相関係数をpandasを使って求めてみましょう。今回求める関係は各説明変数と目的変数の間の関係を求めます。まずは、下準備として、目的変数と説明変数がバラバラになっていますのでpandasのconcatメソッドを使ってデータを合体させましょう。

![](/media/editor/D-3 DataFrame結合_20201130142434664648.png)

###### <font color='red'>目的変数と説明変数を合体させよう</font>

```python
# データフレーム型に変換
df_x = pd.DataFrame(dataset.data, columns=dataset.feature_names)
df_y = pd.DataFrame(dataset.target, columns=["target"])
dfa = pd.concat([df_x, df_y], axis = 1)
```
　ここで出てきた<font color='red'>**axis**</font>と言う引数は縦方向か横方向かどちらに結合させるかを表したもので、列に沿った処理はaxis=0、行に沿った処理はaxis=1と言うように決められています。

## pandasで相関係数を求めてみよう

　では、下準備も終わりましたので早速pandasを用いて相関係数を求めていきしょう。これは非常に簡単で、相関係数を求めたいデータに対して、<font color='red'>**corr**</font>メソッドを使うだけでできます。では実際に使ってみましょう。

 ###### <font color='red'>相関係数をcorrメソッドを使って求めよう</font>

```python
dfa = pd.concat([df_x, df_y], axis = 1)
# 説明変数と目的変数（target）の関係を見るための各相関関係数を出してみます。
corr = dfa.corr()
corr
```

　相関係数が以下のように出力されていませんか？

![](/media/editor/D-3pandasの相関係数_20201130142453811048.png)

　これでどの変数と変数の関係がどの程度の強さなのか数式で表すことができ、みんなが納得する数字となりました。ですが、このまま一個一個見て行っていては今は少ないのでそんない手間ではないでしょうがこれが100変数あったら大変ではないでしょうか？ですので、強さごとに色をつけて見てみることにしましょう。

### 色をつけてみやすくしよう

　先ほどの相関係数の表に色をつけてデータを見やすくしてみましょう。今から以下のような図を作っていきます。飛躍的に見やすくなっていることがわかるでしょう。

![](/media/editor/D-3seabornの相関係数_20201130142512546499.png)

　その際に使うのが、seabornとmatplotlibです。matplotlibに関しては「回帰分析の結果をグラフに表示しよう」で詳しく説明しますので、ここではこう書けばこう動くんだくらいの認識で構いません。
　また、seabornには数多くの表を美しく見せる機能を備えているライブラリーです。簡単に言えば、seabornはグラフを美しかけるけどもできることが少なく、matplotlibはたくさんのグラフに対応しているけども美しくはないことが多いと言うことです。

![](/media/editor/D-3matplotlibとseabornの違い_20201130142537214944.png)

### 実際にseabornを使ってみましょう

　今回はseabornのheatmapという機能を使います。この機能はヒートマップで指定した表を表してくれます。seabornのheatmapの構文は以下の通りです。また、よく使いそうな引数も紹介しておきます。

```python
import seaborn as sns

sns.heatmap(データ, 引数(つけたいオプション分だけ))
```

とするとヒートマップがかけます。ヒートマップの引数について以下の表で説明していきます。ヒートマップの引数は主に、その表に対するオプションとして使われます。他にもたくさんあるので公式サイトを見てみましょう。
[seabornのheatmap公式サイト](https://seaborn.pydata.org/generated/seaborn.heatmap.html?highlight=heatmap#seaborn.heatmap)

|引数|できること|
|:--:|:--|
|vmin|データの最小値を指定してくれます|
|vmax|データの最大値を指定してくれます|
|center|カラーマップを中央に配置する値を指定します|
|annot|Trueで数値を表示させます、指定しないとFalseとなり、値は表示されません|
|fmt|枠の中の少数に与えるルール|
|cmap|カラーコードを変更できる|

**注意**
　カラーコードを使う際ですが、カラーコードは以下のリンクから選ばなければなりません

　[カラーコード](https://matplotlib.org/examples/color/colormaps_reference.html)

# 実際にseabornを使ってみよう

　ここからは、実際にseabornを使ってみましょう。まず、<font color='red'>**seabornとmatplotlibをimport**</font>しましょう。繰り返しになりますが**matplotlibに関しては今は理解しなくても大丈夫です**。

```python
import seaborn as sns
import matplotlib.pyplot as plt
```

######  <font color='red'>searbornにデータを渡して最大値を1、最小値を−1に指定して、centerは0、小数点は2桁まで表示して、annot=True、 cbar=Trueのヒートマップを作ってみみょう</font>

　実習に入る前に以下のコードmatplotlibのimportを書いて図の大きをを指定してください。でないと小さくてみにくくなってしまします。

```python
plt.subplots(figsize=(12, 10))
```

以下のコードを追加して、先ほどのヒートマップを書いてみましょう。

```python
sns.heatmap(dfa.corr(), vmin=-1, vmax=1, center=0, annot=True, fmt=".2f", cbar=True)
```

ヒートマップをかけたでしょうか？

### 適切な説明変数を１つ選ぼう
　ここまでで、カラー付きのみやすいヒートマップができたと思います。
　このヒートマップをみてみましょう。一目瞭然で<font color='red'>**LSTATが最も住宅価格のTARGETに影響を与えている変数**</font>であることがわかります。
　この、LSTATを使って実際に単回帰分析と言われる手法を学んでいきましょう。

# まとめ
　今回は、相関係数という数学的な値を用いてどの説明変数が目的変数を変動させている度合いが強いのかということをみました。
　また、その過程で一般にデータを表示する際に使われるようなモジュールにも触れました。
　seabornは非常に便利なライブラリーですので、描きたいグラフがあったらやり方を調べてみましょう。